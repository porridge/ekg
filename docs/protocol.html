<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
<meta http-equiv="Content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
BODY { font-family: tahoma, verdana, arial, helvetica, sans-serif; }
.tab { background-color: #a0a0a0; }
.tabh { background-color: #d0d0d0; }
.tabf { background-color: white; }
.tabf2 { background-color: white; color: silver; }
.c { font-family: monospace; padding: 0.7em; background-color: #e0e0e0; border: 1px solid #a0a0a0; }
.http { font-family: monospace; padding: 0.7em; background-color: #c0f0c0; border: 1px solid #80a080; }
.example { font-family: monospace; padding: 0.7em; background-color: #c0f0f0; border: 1px solid #80a0a0; }
PRE { margin: 0px; }
H1, H2, H3 { margin-top: 0px; }
</style>
<title>Protokó³ Gadu-Gadu</title>
</head>

<body bgcolor="white" text="black">

<center>
<table width="600" border="0"><tr><td>

<center>
<h1>Protokó³ Gadu-Gadu</h1>
<h3>&copy; Copyright 2001 - 2004 <a href="#ch4">Autorzy</a></h3>
</center>

<hr />

<a name="index"></a>

<h2>Spis tre¶ci</h2>

<ol>
	<li><a href="#ch1">Protokó³ Gadu-Gadu</a><br />
		1.1.&nbsp;&nbsp;<a href="#ch1.1">Format pakietów i konwencje</a><br />
		1.2.&nbsp;&nbsp;<a href="#ch1.2">Zanim siê po³±czymy</a><br />
		1.3.&nbsp;&nbsp;<a href="#ch1.3">Logowanie siê</a><br />
		1.4.&nbsp;&nbsp;<a href="#ch1.4">Zmiana stanu</a><br />
		1.5.&nbsp;&nbsp;<a href="#ch1.5">Ludzie przychodz±, ludzie odchodz±</a><br />
		1.6.&nbsp;&nbsp;<a href="#ch1.6">Wysy³anie wiadomo¶ci</a><br />
		1.7.&nbsp;&nbsp;<a href="#ch1.7">Otrzymywanie wiadomo¶ci</a><br />
		1.8.&nbsp;&nbsp;<a href="#ch1.8">Ping, pong</a><br />
		1.9.&nbsp;&nbsp;<a href="#ch1.9">Roz³±czenie</a><br />
		1.10.&nbsp;&nbsp;<a href="#ch1.10">Katalog publiczny</a><br />
		1.11.&nbsp;&nbsp;<a href="#ch1.11">Lista kontaktów</a><br />
		1.12.&nbsp;&nbsp;<a href="#ch1.12">Indeks pakietów</a><br />
	</li>
	<li><a href="#ch2">Us³ugi HTTP</a><br />
		2.1.&nbsp;&nbsp;<a href="#ch2.1">Format danych</a><br />
		2.2.&nbsp;&nbsp;<a href="#ch2.2">Tokeny</a><br />
		2.3.&nbsp;&nbsp;<a href="#ch2.3">Rejestracja konta</a><br />
		2.4.&nbsp;&nbsp;<a href="#ch2.4">Usuniêcie konta</a><br />
		2.5.&nbsp;&nbsp;<a href="#ch2.5">Zmiana has³a</a><br />
		2.6.&nbsp;&nbsp;<a href="#ch2.6">Przypomnienie has³a poczt±</a><br />
	</li>
	<li><a href="#ch3">Po³±czenia bezpo¶rednie</a><br />
		3.1.&nbsp;&nbsp;<a href="#ch3.1">Nawi±zanie po³±czenia</a><br />
		3.2.&nbsp;&nbsp;<a href="#ch3.2">Przesy³anie plików</a><br />
		3.3.&nbsp;&nbsp;<a href="#ch3.3">Rozmowy g³osowe</a><br />
	</li>
	<li><a href="#ch4">Autorzy</a></li>
</ol>

<hr />

<a name="ch0"></a>
<h2>Informacje wstêpne</h2>

<p>
Opis protoko³u u¿ywanego przez Gadu-Gadu bazuje na do¶wiadczeniach
przeprowadzonych przez autorów oraz informacjach nadsy³anych przez 
u¿ytkowników. ¯aden klient Gadu-Gadu nie zosta³ skrzywdzony podczas
badañ. Reverse-engineering opiera³ siê g³ównie na analizie pakietów
przesy³anych miêdzy klientem a serwerem.
</p>

<p>
Najnowsza wersja opisu protoko³u znajduje siê pod adresem
<a href="http://dev.null.pl/ekg/docs/protocol.html">http://dev.null.pl/ekg/docs/protocol.html</a>.
</p>

<hr />

<a name="ch1"></a>
<h2>1. Protokó³ Gadu-Gadu</h2>

<a name="ch1.1"></a>
<h3>1.1. Format pakietów i konwencje</h3>

<p>
Podobnie jak coraz wiêksza ilo¶æ komunikatorów, Gadu-Gadu korzysta z
protoko³u TCP/IP. Ka¿dy pakiet zawiera na pocz±tku dwa sta³e pola:
</p>

<div class="c">
<pre>struct gg_header {
	int type;	<i>/* typ pakietu */</i>
	int length;	<i>/* d³ugo¶æ reszty pakietu */</i>
};</pre>
</div>

<p>
Wszystkie zmienne liczbowe s± zgodne z kolejno¶ci± bajtów maszyn Intela,
czyli Little-Endian. Wszystkie teksty s± kodowane przy u¿yciu zestawu
znaków CP1250 (windows-1250). Linie koñcz± siê znakami <tt>\r\n</tt>.
</p>

<p>
Przy opisie struktur, za³o¿ono, ¿e <tt>char</tt> ma rozmiar 1 bajtu,
<tt>short</tt> 2 bajtów, <tt>int</tt> 4 bajtów, <tt>long long</tt> 8 bajtów.
U¿ywaj±c architektur innych ni¿ i386, nale¿y zwróciæ szczególn± uwagê na
rozmiar typów zmiennych i kolejno¶æ bajtów. Poza tym, wiêkszo¶æ dostêpnych
obecnie kompilatorów domy¶lnie wyrównuje zmienne do rozmiaru s³owa danej
architektury, wiêc nale¿y wy³±czyæ t± funkcjê. W przypadku gcc bêdzie to
<tt>__attribute__ ((packed))</tt> zaraz za deklaracj± ka¿dej struktury, a dla
Microsoft Visual C++ powinno pomóc:
</p>

<div class="c">
<pre>#pragma pack(push, 1)

<i>/* deklaracje */</i>

#pragma pack(pop)</pre>
</div>

<p>
Pola, który znaczenie jest nieznane, lub nie do koñca jasne, oznaczono
przedrostkiem <tt>unknown</tt>.
</p>

<p>
Mo¿liwe jest po³±czenie za po¶rednictwem protoko³u TLSv1. Szczegó³y znajduj±
siê w poni¿szym opisie.
</p>

<hr />

<a name="ch1.2"></a>
<h3>1.2. Zanim siê po³±czymy</h3>

<p>
¯eby wiedzieæ, z jakim serwerem mamy siê po³±czyæ, nale¿y za pomoc± HTTP
po³±czyæ siê z <tt>appmsg.gadu-gadu.pl</tt> i wys³aæ:
</p>

<div class="http">
<pre>GET /appsvc/appmsg4.asp?fmnumber=<b>NUMER</b>&amp;version=<b>WERSJA</b>&amp;fmt=<b>FORMAT</b>&amp;lastmsg=<b>WIADOMO¦Æ</b>
Accept: image/gif, image/jpeg, image/pjpeg, <b>...</b>
Accept-Language: pl
User-Agent: <b>PRZEGL¡DARKA</b>
Pragma: no-cache
Host: appmsg.gadu-gadu.pl</pre>
</div>

<p>
<b>NUMER</b> jest numerem Gadu-Gadu. <b>WERSJA</b> jest wersj± klienta
w postaci ,,<tt>A, B, C, D</tt>'' (na przyk³ad ,,<tt>5, 0, 5, 107</tt>'' dla
wersji 5.0.5 build 107).
<b>FORMAT</b> okre¶la czy wiadomo¶æ systemowa bêdzie przesy³ana czystym
tekstem (brak zmiennej "fmt") czy w HTMLu (warto¶æ ,,<tt>2</tt>'').
<b>WIADOMO¦Æ</b> jest numerem ostatnio otrzymanej wiadomo¶ci systemowej.
<b>PRZEGL¡DARKA</b> mo¿e byæ jednym z poni¿szych tekstów:
</p>

<ul>
<li><tt>Mozilla/4.04 [en] (Win95; I ;Nav)</tt></li>
<li><tt>Mozilla/4.7 [en] (Win98; I)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows NT)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows 98; DigExt)</tt></li>
<li><tt>Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)</tt></li>
</ul>

<p>
Na postawione w ten sposób zapytanie, serwer powinien odpowiedzieæ
na przyk³ad tak:
</p>

<div class="http">
<pre>HTTP/1.0 200 OK

0 0 217.17.41.84:8074 217.17.41.84</pre>
</div>

<p>
Pierwsze pole jest numerem wiadomo¶ci systemowej, a trzecie i czwarte
podaj± nam namiary na w³a¶ciwy serwer. Je¶li serwer jest niedostêpny,
zamiast adresu IP jest zwracany tekst ,,<tt>notoperating</tt>''.
Je¿eli po³±czenie z portem 8074 nie powiedzie siê z jakich¶ powodów,
mo¿na siê ³±czyæ na port 443. 
</p>

<p>
Je¶li pierwsza liczba nie jest równa zero, zaraz po nag³ówku znajduje siê
wiadomo¶æ systemowa, lub je¶li linia zaczyna siê od znaku ,,<tt>@</tt>'',
adres strony, któr± nale¿y otworzyæ w przegl±darce.
</p>

<p>
Je¶li klient chce siê ³±czyæ za pomoc± protoko³u TLSv1, wysy³a zapytanie
do innego skryptu (,,<tt>appmsg3.asp</tt>'') i otrzymuje w odpowiedzi adres
serwera oraz port 443. Protokó³ jest identyczny, z tym wyj±tkiem, ¿e ca³a
transmisja jest szyfrowana. Dobrym zwyczajem jest równie¿ sprawdzane
autentyczno¶ci certyfikatu, by unikn±æ ataków typu man-in-the-middle.
</p>

<div class="http">
<pre>GET /appsvc/appmsg3.asp?fmnumber=<b>NUMER</b>&amp;version=<b>WERSJA</b>&amp;fmt=<b>FORMAT</b>&amp;lastmsg=<b>WIADOMO¦Æ</b>
Host: appmsg.gadu-gadu.pl
User-Agent: <b>PRZEGL¡DARKA</b>
Pragma: no-cache</pre>
</div>

<hr />

<a name="ch1.3"></a>
<h3>1.3. Logowanie siê</h3>

<p>
Po po³±czeniu siê portem 8074 lub 443 serwera Gadu-Gadu, otrzymujemy pakiet
typu <tt>0x0001</tt>, który na potrzeby tego dokumentu nazwiemy:
</p>

<div class="c">
<pre>#define GG_WELCOME 0x0001</pre>
</div>

<p>
Reszta pakietu zawiera liczbê, na podstawie której liczony jest hash z has³a
klienta:
</p>

<div class="c">
<pre>struct gg_welcome {
	int seed;	<i>/* klucz szyfrowania has³a */</i>
};</pre>
</div>

<p>
Kiedy mamy ju¿ t± warto¶æ mo¿emy odes³aæ pakiet logowania:
</p>

<div class="c">
<pre>#define GG_LOGIN60 0x0015

struct gg_login60 {
	int uin;              <i>/* mój numerek */</i>
        int hash;             <i>/* hash has³a */</i>
        int status;           <i>/* status na dzieñ dobry */</i>
        int version;          <i>/* moja wersja klienta */</i>
        char unknown1;        <i>/* 0x00 */</i>
        int local_ip;         <i>/* mój adres ip */</i>
	short local_port;     <i>/* port, na którym s³ucham */</i>
        int external_ip;      <i>/* zewnêtrzny adres ip */</i>
        short external_port;  <i>/* zewnêtrzny port */</i>
	char image_size;      <i>/* maksymalny rozmiar grafiki w KB */</i>
        char unknown2;        <i>/* 0xbe */</i>
	char description[];   <i>/* opis, nie musi wyst±piæ */</i>
	int time;             <i>/* czas, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Hash has³a mo¿na obliczyæ nastêpuj±c± funkcj± jêzyka C:
</p>

<div class="example">
<pre>int gg_login_hash(unsigned char *password, unsigned int seed)
{
	unsigned int x, y, z;

	y = seed;

	for (x = 0; *password; password++) {
		x = (x &amp; 0xffffff00) | *password;
		y ^= x;
		y += x;
		x &lt;&lt;= 8;
		y ^= x;
		x &lt;&lt;= 8;
		y -= x;
		x &lt;&lt;= 8;
		y ^= x;

		z = y &amp; 0x1f;
		y = (y &lt;&lt; z) | (y &gt;&gt; (32 - z));
	}

	return y;
}</pre>
</div>

<p>
Liczba oznaczaj±ca wersjê mo¿e byæ jedn± z poni¿szych:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Wersje klientów</b></td></tr>
<tr class="tabf"><td><tt>0x24</tt></td><td>6.1 (build 155)</td></tr>
<tr class="tabf"><td><tt>0x22</tt></td><td>6.0 (build 140)</td></tr>
<tr class="tabf"><td><tt>0x21</tt></td><td>6.0 (build 133)</td></tr>
<tr class="tabf"><td><tt>0x20</tt></td><td>6.0</td></tr>
<tr class="tabf"><td><tt>0x1e</tt></td><td>5.7 beta (build 121)</td></tr>
<tr class="tabf"><td><tt>0x1c</tt></td><td>5.7 beta</td></tr>
<tr class="tabf"><td><tt>0x1b</tt></td><td>5.0.5</td></tr>
<tr class="tabf"><td><tt>0x19</tt></td><td>5.0.3</td></tr>
<tr class="tabf"><td><tt>0x18</tt></td><td>5.0.1, 5.0.0, 4.9.3</td></tr>
<tr class="tabf"><td><tt>0x17</tt></td><td>4.9.2</td></tr>
<tr class="tabf"><td><tt>0x16</tt></td><td>4.9.1</td></tr>
<tr class="tabf"><td><tt>0x15</tt></td><td>4.8.9</td></tr>
<tr class="tabf"><td><tt>0x14</tt></td><td>4.8.3, 4.8.1</td></tr>
<tr class="tabf"><td><tt>0x11</tt></td><td>4.6.10, 4.6.1</td></tr>
<tr class="tabf"><td><tt>0x10</tt></td><td>4.5.22, 4.5.21, 4.5.19, 4.5.17, 4.5.15</td></tr>
<tr class="tabf"><td><tt>0x0f</tt></td><td>4.5.12</td></tr>
<tr class="tabf"><td><tt>0x0b</tt></td><td>4.0.30, 4.0.29, 4.0.28, 4.0.25</td></tr>
</table>

<p>
Oczywi¶cie nie s± to wszystkie mo¿liwe wersje klientów, lecz te, które
zosta³y zauwa¿one i odnotowane. W ka¿dym razie, tak czy inaczej nale¿y
siê przedstawiæ jako co najmniej wersja 6.0, poniewa¿ tej wersji protoko³u
dotyczy poni¿szy dokument.
</p>

<p>
Je¶li klient ma kartê d¼wiêkow± i jest w stanie obs³ugiwaæ rozmowy g³osowe,
do wersji dodawana jest warto¶æ:
</p>

<div class="c">
<pre>#define GG_HAS_AUDIO_MASK 0x40000000</pre>
</div>

<p>
Je¶li osoba korzysta z bramki Era Omnix, do wersji dodawana jest warto¶æ:
</p>

<div class="c">
<pre>#define GG_ERA_OMNIX_MASK 0x04000000</pre>
</div>

<p>
Je¶li autoryzacja siê powiedzie, dostaniemy w odpowiedzi pakiet:
</p>

<div class="c">
<pre>#define GG_LOGIN_OK 0x0003</pre>
</div>

<p>
o zerowej d³ugo¶ci, lub w przypadku b³êdu pakiet:
</p>

<div class="c">
<pre>#define GG_LOGIN_FAILED 0x0009</pre>
</div>


<hr />

<a name="ch1.4"></a>
<h3>1.4. Zmiana stanu</h3>

<p>
Gadu-Gadu przewiduje kilka stanów klienta, które zmieniamy pakietem typu:
</p>

<div class="c">
<pre>#define GG_NEW_STATUS 0x0002
	
struct gg_new_status {
	int status;		<i>/* na jaki zmieniæ? */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
}</pre>
</div>

<p>
Mo¿liwe stany to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_STATUS_NOT_AVAIL</tt></td><td><tt>0x0001</tt></td><td>Niedostêpny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_NOT_AVAIL_DESCR</tt></td><td><tt>0x0015</tt></td><td>Niedostêpny (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_AVAIL</tt></td><td><tt>0x0002</tt></td><td>Dostêpny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_AVAIL_DESCR</tt></td><td><tt>0x0004</tt></td><td>Dostêpny (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BUSY</tt></td><td><tt>0x0003</tt></td><td>Zajêty</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BUSY_DESCR</tt></td><td><tt>0x0005</tt></td><td>Zajêty (z opisem)</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_INVISIBLE</tt></td><td><tt>0x0014</tt></td><td>Niewidoczny</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_INVISIBLE_DESCR</tt></td><td><tt>0x0016</tt></td><td>Niewidoczny z opisem</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_BLOCKED</tt></td><td><tt>0x0006</tt></td><td>Zablokowany</td></tr>
<tr class="tabf"><td><tt>GG_STATUS_FRIENDS_MASK</tt></td><td><tt>0x8000</tt></td><td>Maska bitowa oznaczaj±ca tryb tylko dla przyjació³</td></tr>
</table>

<p>
Nale¿y pamiêtaæ, ¿eby przed roz³±czeniem siê z serwerem nale¿y zmieniæ
stan na <tt>GG_STATUS_NOT_AVAIL</tt> lub <tt>GG_STATUS_NOT_AVAIL_DESCR</tt>.
Je¶li ma byæ widoczny tylko dla przyjació³, nale¿y dodaæ
<tt>GG_STATUS_FRIENDS_MASK</tt> do normalnej warto¶ci stanu.
</p>

<p>
Je¶li wybieramy stan opisowy, nale¿y do³±czyæ ci±g znaków zakoñczony
zerem oraz ewentualny czas powrotu w postaci ilo¶ci sekund od 1 stycznia
1970r (UTC). Maksymalna d³ugo¶æ opisu wynosi 70 znaków plus zero plus
4 bajty na godzinê powrotu, co razem daje 75 bajtów.
</p>

<hr />

<a name="ch1.5"></a>
<h3>1.5. Ludzie przychodz±, ludzie odchodz±</h3>

<p>
Zaraz po zalogowaniu mo¿emy wys³aæ serwerowi nasz± listê kontaktów, ¿eby
dowiedzieæ siê, czy s± w danej chwili dostêpni. Lista kontaktów jest dzielona
na pakiety po 400 wpisów. Pierwsze wpisy s± typu <tt>GG_NOTIFY_FIRST</tt>,
a ostatni typu <tt>GG_NOTIFY_LAST</tt>, ¿eby serwer wiedzia³, kiedy koñczymy.
Je¶li lista kontaktów jest mniejsza ni¿ 400 wpisów, wysy³amy oczywi¶cie tylko
<tt>GG_NOTIFY_LAST</tt>. Pakiety te zawieraj± struktury <tt>gg_notify</tt>:
</p>

<div class="c">
<pre>#define GG_NOTIFY_FIRST 0x000f
#define GG_NOTIFY_LAST 0x0010
	
struct gg_notify {
	int uin;	<i>/* numerek danej osoby */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>	
</div>

<p>
Gdzie pole <tt>type</tt> jest map± bitow± nastêpuj±cych warto¶ci:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_USER_BUDDY</tt></td><td><tt>0x01</tt></td><td>Ka¿dy u¿ytkownik dodany do listy kontaktów</td></tr>
<tr class="tabf"><td><tt>GG_USER_FRIEND</tt></td><td><tt>0x02</tt></td><td>U¿ytkownik, dla którego jeste¶my widoczni w trybie ,,tylko dla przyjació³''</td></tr>
<tr class="tabf"><td><tt>GG_USER_BLOCKED</tt></td><td><tt>0x04</tt></td><td>U¿ytkownik, którego wiadomo¶ci nie chcemy otrzymywaæ</td></tr>
</table>

<p>
Jednak dla zachowania starego nazewnictwa sta³ych mo¿na u¿ywaæ najczê¶ciej spotykane warto¶ci to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_USER_OFFLINE</tt></td><td><tt>0x01</tt></td><td>U¿ytkownik, dla którego bêdziemy niedostêpni, ale mamy go w li¶cie kontaktów</td></tr>
<tr class="tabf"><td><tt>GG_USER_NORMAL</tt></td><td><tt>0x03</tt></td><td>Zwyk³y u¿ytkownik dodany do listy kontaktów</td></tr>
<tr class="tabf"><td><tt>GG_USER_BLOCKED</tt></td><td><tt>0x04</tt></td><td>U¿ytkownik, którego wiadomo¶ci nie chcemy otrzymywaæ</td></tr>
</table>

<p>
Je¶li nie mamy nikogo na li¶cie wysy³amy pakiet:
</p>

<div class="c">
<pre>#define GG_LIST_EMPTY 0x0012</pre>
</div>

<p>	
o zerowej d³ugo¶ci.
</p>

<p>
Je¶li kto¶ jest, serwer odpowie pakietem <tt>GG_NOTIFY_REPLY</tt> albo
<tt>GG_NOTIFY_REPLY60</tt> zawieraj±cym jedn± lub wiêcej struktur
<tt>gg_notify_reply60</tt>: </p>

<div class="c">
<pre>#define GG_NOTIFY_REPLY 0x000c
	
struct gg_notify_reply {
	int uin;		/* numer */
	char status;		/* status danej osoby */
	int remote_ip;		/* adres ip delikwenta */
	short remote_port;	/* port, na którym s³ucha klient */
	int version;		/* wersja klienta */
	short unknown1;		/* znowu port? */
	char description[];	/* opis, nie musi wyst±piæ */
	int time;		/* czas, nie musi wyst±piæ */
};
	
#define GG_NOTIFY_REPLY60 0x0011
	
struct gg_notify_reply60 {
	int uin;		/* numerek plus flagi w najstarszym bajcie */
	char status;		/* status danej osoby */
	int remote_ip;		/* adres IP bezpo¶rednich po³±czeñ */
	short remote_port;	/* port bezpo¶rednich po³±czeñ */
	char version;		/* wersja klienta */
	char image_size;	/* maksymalny rozmiar obrazków w KB */
	char unknown1;		/* 0x00 */
	char description_size;	/* rozmiar opisu i czasu, nie musi wyst±piæ */
	char description[];	/* opis, nie musi wyst±piæ */
	int time;		/* czas, nie musi wyst±piæ */
};</pre>
</div>

<p>
W najstarszym bajcie pola <tt>uin</tt> mog± znajdowaæ siê nastêpuj±ce flagi:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_UINFLAG_UNKNOWN1</tt></td><td><tt>0x10</tt></td><td>Nieznane</td></tr>
<tr class="tabf"><td><tt>GG_UINFLAG_UNKNOWN2</tt></td><td><tt>0x20</tt></td><td>Flaga spotykana, gdy u¿ytkownik staje siê niedostêpny</td></tr>
<tr class="tabf"><td><tt>GG_UINFLAG_VOICE</tt></td><td><tt>0x40</tt></td><td>U¿ytkownik mo¿e prowadziæ rozmowy g³osowe</td></tr>
<tr class="tabf"><td><tt>GG_UINFLAG_ERA_OMNIX</tt></td><td><tt>0x08</tt></td><td>U¿ytkownik ³±czy siê przez bramkê Era Omnix</td></tr>
</table>

<p><tt>remote_port</tt> poza zwyk³ym
portem mo¿e przyjmowaæ równie¿ poni¿sze warto¶ci:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td>0</td><td>Klient nie obs³uguje bezpo¶rednich po³±czeñ</td></tr>
<tr class="tabf"><td>1</td><td>Klient ³±czy siê zza NAT lub innej formy maskarady</td></tr>
<tr class="tabf"><td>2</td><td>Klient nie ma nas w swojej li¶cie kontaktów</td></tr>
</table>

<p>
Zdarzaj± siê te¿ inne ,,nietypowe'' warto¶ci, ale ich znaczenie nie jest
jeszcze do koñca znane.
</p>

<p>
¯eby dodaæ kogo¶ do listy w trakcie pracy, trzeba wys³aæ ni¿ej opisany
pakiet. Jego format jest identyczny jak <tt>GG_NOTIFY_*</tt>. Dodaje
on flagi rodzaju u¿ytkownika.
</p>

<div class="c">
<pre>#define GG_ADD_NOTIFY 0x000d
	
struct gg_add_notify {
	int uin;	<i>/* numerek */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>
</div>

<p>
Poni¿szy pakiet usuwa flagi rodzaj u¿ytkownika, wiêc mo¿na go wykorzystaæ
zarówno do usuniêcia u¿ytkownika z listy kontaktów, jak i do zmiany rodzaju.
</p>

<div class="c">
<pre>#define GG_REMOVE_NOTIFY 0x000e
	
struct gg_remove_notify {
	int uin;	<i>/* numerek */</i>
	char type;	<i>/* rodzaj u¿ytkownika */</i>
};</pre>
</div>

<p>
Je¶li kto¶ opu¶ci Gadu-Gadu lub zmieni stan, otrzymamy jeden z pakietów:
</p>

<div class="c">
<pre>#define GG_STATUS 0x0002
	
struct gg_status {
	int uin;	        <i>/* numer */</i>
	int status;	        <i>/* nowy stan */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
};
	
#define GG_STATUS60 0x000f
	
struct gg_status60 {
	int uin;	        <i>/* numer plus flagi w najstarszym bajcie */</i>
	char status;	        <i>/* nowy stan */</i>
	int remote_ip;		<i>/* adres IP bezpo¶rednich po³±czeñ */</i>
	short remote_port;	<i>/* port bezpo¶rednich po³±czeñ */</i>
	char version;		<i>/* wersja klienta */</i>
	char image_size;	<i>/* maksymalny rozmiar grafiki */</i>
	char unknown1;		<i>/* 0x00 */</i>
	char description[];	<i>/* opis, nie musi wyst±piæ */</i>
	int time;		<i>/* czas, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Znaczenie pól jest takie samo jak w <tt>struct gg_notify_reply60</tt>.
</p>

<hr />

<a name="ch1.6"></a>
<h3>1.6. Wysy³anie wiadomo¶ci</h3>

<p>
Wiadomo¶ci wysy³a siê nastêpuj±cym typem pakietu:
</p>

<div class="c">
<pre>#define GG_SEND_MSG 0x000b

struct gg_send_msg {
	int recipient;		<i>/* numer odbiorcy */</i>
	int seq;		<i>/* numer sekwencyjny */</i>
	int class;		<i>/* klasa wiadomo¶ci */</i>
	char message[];		<i>/* tre¶æ */</i>
};</pre>
</div>

<p>
Numer sekwencyjny jest wykorzystywany przy potwierdzeniu dostarczenia
lub zakolejkowania pakietu. Nie jest wykluczone, ¿e w jaki¶ sposób odró¿nia
siê ró¿ne rozmowy za pomoc± czê¶ci bajtów, ale raczej nie powinno mieæ to
ma znaczenia. Klasa wiadomo¶ci pozwala odró¿niæ, czy wiadomo¶æ ma siê
pojawiæ w osobnym okienku czy jako kolejna linijka w okienku rozmowy. Jest
to mapa bitowa, wiêc najlepiej ignorowaæ te bity, których znaczenia nie
znamy:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_CLASS_QUEUED</tt></td><td><tt>0x0001</tt></td><td>Bit ustawiany wy³±cznie przy odbiorze wiadomo¶ci, gdy wiadomo¶æ zosta³a wcze¶niej zakolejkowania z powodu nieobecno¶ci</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_MSG</tt></td><td><tt>0x0004</tt></td><td>Wiadomo¶æ ma siê pojawiæ w osobnym okienku</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_CHAT</tt></td><td><tt>0x0008</tt></td><td>Wiadomo¶æ jest czê¶ci± tocz±cej siê rozmowy i zostanie wy¶wietlona w istniej±cym okienku</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_CTCP</tt></td><td><tt>0x0010</tt></td><td>Wiadomo¶æ jest przeznaczona dla klienta Gadu-Gadu i nie powinna byæ wy¶wietlona u¿ytkownikowi.</td></tr>
<tr class="tabf"><td><tt>GG_CLASS_ACK</tt></td><td><tt>0x0020</tt></td><td>Klient nie ¿yczy sobie potwierdzenia wiadomo¶ci.</td></tr>
</table>

<p>
D³ugo¶æ tre¶ci wiadomo¶ci nie powinna przekraczaæ 2000 znaków. Oryginalny
klient zezwala na wys³anie do 1989 znaków.
</p>

<p>
Oryginalny klient wysy³aj±c wiadomo¶æ do kilku u¿ytkowników, wysy³a po
kilka takich samych pakietów z ró¿nymi numerkami odbiorców. Nie ma osobnego
pakietu do tego. Natomiast je¶li chodzi o <i>po³±czenia konferencyjne</i>
do pakietu doklejana jest nastêpuj±ca struktura:
</p>

<div class="c">
<pre>struct gg_msg_recipients {
	char flag;		<i>/* == 1 */</i>
	int count;		<i>/* ilo¶æ odbiorców */</i>
	int recipients[];	<i>/* tablica odbiorców */</i>
};</pre>
</div>

<p>
Na przyk³ad, by wys³aæ do dwóch osób, nale¿y wys³aæ pakiet:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Offset</b></td><td><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><i>n</i></td><td>Tre¶æ wiadomo¶ci</td></tr>
<tr class="tabf"><td><i>m</i></td><td><tt>0x01</tt> (wiadomo¶æ konferencyjna)</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;1</td><td rowspan="4"><tt>0x02</tt> (ilo¶æ adresatów)</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;2</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;3</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;4</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;5</td><td rowspan="4">Numer pierwszego adresata</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;6</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;7</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;8</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;9</td><td rowspan="4">Numer drugiego adresata</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;10</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;11</td></tr>
<tr class="tabf"><td><i>m</i>&nbsp;+&nbsp;12</td></tr>
</table>

<p>
Od wersji 4.8.1 mo¿liwe jest równie¿ dodawanie do wiadomo¶ci ró¿nych
atrybutów tekstu, jak pogrubienie czy kolory. Niezbêdne jest do³±czenie
nastêpuj±cej struktury:
</p>

<div class="c">
<pre>struct gg_msg_richtext {
	char flag;	<i>/* == 2 */</i>
	short length;	<i>/* d³ugo¶æ dalszej czê¶ci */</i>
};</pre>
</div>

<p>
Dalsza czê¶æ pakietu zawiera odpowiedni± ilo¶æ struktur o ³±cznej d³ugo¶ci
okre¶lonej polem <tt>length</tt>:
</p>

<div class="c">
<pre>struct gg_msg_richtext_format {
	short position;	<i>/* pozycja atrybutu w tek¶cie */</i>
	char font;	<i>/* atrybuty czcionki */</i>
	char rgb[3];	<i>/* kolor czcionki, nie musi wyst±piæ */</i>
	struct gg_msg_richtext_image image; <i>/* nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Ka¿da z tych struktur okre¶la kawa³ek tekstu pocz±wszy od znaku okre¶lonego
przez pole <tt>position</tt> (liczone od zera) a¿ do nastêpnego wpisu lub
koñca tekstu. Pole <tt>font</tt> jest map± bitow± i kolejne bity maj±
nastêpuj±ce znaczenie:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_FONT_BOLD</tt></td><td><tt>0x01</tt></td><td>Pogrubiony tekst</td></tr>
<tr class="tabf"><td><tt>GG_FONT_ITALIC</tt></td><td><tt>0x02</tt></td><td>Kursywa</td></tr>
<tr class="tabf"><td><tt>GG_FONT_UNDERLINE</tt></td><td><tt>0x04</tt></td><td>Podkre¶lenie</td></tr>
<tr class="tabf"><td><tt>GG_FONT_COLOR</tt></td><td><tt>0x08</tt></td><td>Kolorowy tekst. Tylko w tym wypadku struktura <tt>gg_msg_richtext_format</tt> zawiera pole <tt>rgb[]</tt> bêd±ce opisem trzech sk³adowych koloru, kolejno czerwonej, zielonej i niebieskiej.</td></tr>
<tr class="tabf"><td><tt>GG_FONT_IMAGE</tt></td><td><tt>0x80</tt></td><td>Obrazek. Tylko w tym wypadku struktura <tt>gg_msg_richtext_format</tt> zawiera pole <tt>image</tt>.</td></tr>
</table>

<p>
Je¶li wiadomo¶æ zawiera obrazek, przesy³ana jest jego suma kontrolna CRC32
i rozmiar. Dziêki temu nie trzeba za ka¿dym razem wysy³aæ ka¿dego obrazka --
klienty je zachowuj±. Struktura <tt>gg_msg_richtext_image</tt> opisuj±ca
obrazek umieszczony w wiadomo¶ci wygl±da nastêpuj±co:
</p>

<div class="c">
<pre>struct gg_msg_richtext_image {
	short unknown1;	<i>/* 0x0109 */</i>
	long size;	<i>/* rozmiar obrazka */</i>
	long crc32;	<i>/* suma kontrolna obrazka */</i>
};</pre>
</div>

<p>
Gdy klient nie pamiêta obrazka o podanych parametrach, wysy³a pust± wiadomo¶æ
o klasie <tt>GG_CLASS_MSG</tt> z do³±czon± struktur±
<tt>gg_msg_image_request</tt>:
</p>

<div class="c">
<pre>struct gg_msg_image_request {
	char flag;	<i>/* 0x04 */</i>
	int size;	<i>/* rozmiar */</i>
	int crc32;	<i>/* suma kontrolna */</i>
};</pre>
</div>

<p>
Przyk³adowa tre¶æ wiadomo¶ci z pro¶b± o wys³anie obrazka o d³ugo¶ci 258 bajtów
i sumie kontrolnej 0x12345678 to:
</p>

<div class="example">
<pre>00 04 02 01 00 00 78 56 34 12</pre>
</div>

<p>
W odpowiedzi, drugi klient wysy³a obrazek za pomoc± wiadomo¶ci o zerowej
d³ugo¶ci (nale¿y pamiêtaæ o koñcz±cym bajcie o warto¶ci 0x00) z do³±czon±
struktur± <tt>gg_msg_image_reply</tt>:
</p>

<div class="c">
<pre>struct gg_msg_image_reply {
	char flag;      	<i>/* 0x05 lub 0x06 */</i>
	int size;       	<i>/* rozmiar */</i>
	int crc32;      	<i>/* suma kontrolna */</i>
	char filename[];	<i>/* nazwa pliku, nie musi wyst±piæ */</i>
	char image[];		<i>/* zawarto¶æ obrazka */</i>
};</pre>
</div>

<p>
Je¶li d³ugo¶æ struktury <tt>gg_msg_image_reply</tt> jest d³u¿sza ni¿ 1909
bajtów, tre¶æ obrazka jest dzielona na kilka pakietów nie przeraczaj±cych
1909 bajtów. Pierwszy pakiet ma pole <tt>flag</tt> równe 0x05 i ma wype³nione
pole <tt>filename</tt>, a w kolejnych pole <tt>flag</tt> jest równe 0x06
i pole <tt>filename</tt> w ogóle nie wystêpuje (nawet bajt zakoñczenia ci±gu
znaków).
</p>

<p>
Przyk³adowo, by przes³aæ tekst ,,ala <b>ma</b> kota'', nale¿y do³±czyæ do
wiadomo¶ci nastêpuj±c± sekwencjê bajtów:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Offset</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><i>n</i></td><td><tt>0x02</tt></td><td>Opis atrybutów tekstu...</td></tr>
<tr class="tabf"><td><i>n</i> + 1</td><td rowspan="2"><tt>0x0006</tt></td><td rowspan="2">...maj±cy 6 bajtów d³ugo¶ci</td></tr>
<tr class="tabf"><td><i>n</i> + 2</td></tr>
<tr class="tabf"><td><i>n</i> + 3</td><td rowspan="2"><tt>0x0004</tt></td><td rowspan="2">Atrybut zaczyna siê od pozycji 4...</td></tr>
<tr class="tabf"><td><i>n</i> + 4</td></tr>
<tr class="tabf"><td><i>n</i> + 5</td><td><tt>0x01</tt></td><td>...i jest to pogrubiony tekst</td></tr>
<tr class="tabf"><td><i>n</i> + 6</td><td rowspan="2"><tt>0x0006</tt></td><td rowspan="2">Atrybut zaczyna siê od pozycji 6...</td></tr>
<tr class="tabf"><td><i>n</i> + 7</td></tr>
<tr class="tabf"><td><i>n</i> + 8</td><td><tt>0x00</tt></td><td>...i jest to zwyk³y tekst</td></tr>
</table>

<p>
Serwer po otrzymaniu wiadomo¶ci odsy³a potwierdzenie, które przy okazji
mówi nam, czy wiadomo¶æ dotar³a do odbiorcy czy zosta³a zakolejkowana
z powodu nieobecno¶ci. Otrzymujemy je w postaci pakietu:
</p>

<div class="c">
<pre>#define GG_SEND_MSG_ACK 0x0005
	
struct gg_send_msg_ack {
	int status;	<i>/* stan wiadomo¶ci */</i>
	int recipient;	<i>/* numer odbiorcy */</i>
	int seq;	<i>/* numer sekwencyjny */</i>
};</pre>
</div>

<p>
Numer sekwencyjny i numer adresata s± takie same jak podczas wysy³ania,
a stan wiadomo¶ci mo¿e byæ jednym z nastêpuj±cych:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_ACK_BLOCKED</tt></td><td><tt>0x0001</tt></td><td>Wiadomo¶ci nie przes³ano (zdarza siê przy wiadomo¶ciach zawieraj±cych adresy internetowe blokowanych przez serwer GG gdy odbiorca nie ma nas na li¶cie)</td></tr>
<tr class="tabf"><td><tt>GG_ACK_DELIVERED</tt></td><td><tt>0x0002</tt></td><td>Wiadomo¶æ dostarczono</td></tr>
<tr class="tabf"><td><tt>GG_ACK_QUEUED</tt></td><td><tt>0x0003</tt></td><td>Wiadomo¶æ zakolejkowano</td></tr>
<tr class="tabf"><td><tt>GG_ACK_MBOXFULL</tt></td><td><tt>0x0004</tt></td><td>Wiadomo¶ci nie dostarczono. Skrzynka odbiorcza na serwerze jest pe³na (20 wiadomo¶ci maks). Wystêpuje tylko w trybie offline</td></tr>
<tr class="tabf"><td><tt>GG_ACK_NOT_DELIVERED</tt></td><td><tt>0x0006</tt></td><td>Wiadomo¶ci nie dostarczono. Odpowied¼ ta wystêpuje tylko w przypadku wiadomo¶ci klasy <tt>GG_CLASS_CTCP</tt></td></tr>
</table>

<hr />

<a name="ch1.7"></a>
<h3>1.7. Otrzymywanie wiadomo¶ci</h3>

<p>
Wiadomo¶ci serwer przysy³a za pomoc± pakietu:
</p>

<div class="c">
<pre>#define GG_RECV_MSG 0x000a
	
struct gg_recv_msg {
	int sender;		<i>/* numer nadawcy */</i>
	int seq;		<i>/* numer sekwencyjny */</i>
	int time;		<i>/* czas nadania */</i>
	int class;		<i>/* klasa wiadomo¶ci */</i>
	char message[];		<i>/* tre¶æ wiadomo¶ci */</i>
};</pre>
</div>

<p>
Czas nadania jest zapisany w postaci UTC, jako ilo¶ci sekund od 1 stycznie
1970r.
</p>

<p>
W przypadku pakietów ,,konferencyjnych'' na koñcu pakietu doklejona jest
struktura identyczna z <tt>gg_msg_recipients</tt> zawieraj±ca pozosta³ych
rozmówców.
</p>

<hr />

<a name="ch1.8"></a>
<h3>1.8. Ping, pong</h3>

<p>
Od czasu do czasu klient wysy³a pakiet do serwera, by oznajmiæ, ¿e po³±czenie
jeszcze jest utrzymywane. Je¶li serwer nie dostanie takiego pakietu w
przeci±gu 5 minut, zrywa po³±czenie. To, czy klient dostaje odpowied¼
zmienia siê z wersji na wersjê, wiêc najlepiej nie polegaæ na tym.
</p>

<div class="c">
<pre>#define GG_PING 0x0008

#define GG_PONG 0x0007</pre>
</div>

<hr />

<a name="ch1.9"></a>
<h3>1.9. Roz³±czenie</h3>

<p>
Je¶li serwer zechce nas roz³±czyæ, wy¶le wcze¶niej pusty pakiet:
</p>

<div class="c">
<pre>#define GG_DISCONNECTING 0x000b</pre>
</div>

<p>
Ma to miejsce, gdy próbowano zbyt wiele razy po³±czyæ siê z nieprawid³owym
has³em, lub gdy równocze¶nie po³±czy siê drugi klient z tym samym numerem
(nowe po³±czenie ma wy¿szy priorytet).
</p>

<hr />

<a name="ch1.10"></a>
<h3>1.10. Katalog publiczny</h3>

<p>
Od wersji 5.0.2 zmieniono sposób dostêpu do katalogu publicznego -- sta³
siê czê¶ci± sesji, zamiast osobnej sesji HTTP. Aby obs³ugiwaæ wyszukiwanie
osób, odczytywanie w³asnych informacji lub ich modyfikacjê nale¿y u¿yæ
nastêpuj±cego typu pakietu:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_REQUEST 0x0014
	
struct gg_pubdir50 {
	char type;
	int seq;
	char request[];
};</pre>
</div>

<p>
Pole <tt>type</tt> oznacza rodzaj zapytania:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_WRITE 0x01
#define GG_PUBDIR50_READ 0x02
#define GG_PUBDIR50_SEARCH 0x03</pre>
</div>

<p>
Pole <tt>seq</tt> jest numerem sekwencyjnym zapytania, ró¿nym od zera,
zwracanym równie¿
w wyniku. Oryginalny klient tworzy go na podstawie aktualnego czasu.
<tt>request</tt> zawiera parametry zapytania. Ilo¶æ jest dowolna. Ka¿dy
parametr jest postaci <tt>"<b>nazwa</b>\0<b>warto¶æ</b>\0"</tt>, tzn.
nazwa od warto¶ci s± oddzielone znakiem o kodzie 0, podobnie jak kolejne
parametry od siebie. Mo¿liwe parametry zapytania to:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_UIN</tt></td><td><tt>FmNumber</tt></td><td>Numer szukanej osoby</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FIRSTNAME</tt></td><td><tt>firstname</tt></td><td>Imiê</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_LASTNAME</tt></td><td><tt>lastname</tt></td><td>Nazwisko</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_NICKNAME</tt></td><td><tt>nickname</tt></td><td>Pseudonim</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_BIRTHYEAR</tt></td><td><tt>birthyear</tt></td><td>Rok urodzenia. Je¶li chcemy szukaæ osób z danego przedzia³u, podajemy rok pocz±tkowy i koñcowy, oddzielone spacj±. Na przyk³ad ,,<tt>1980 1985</tt>''.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_CITY</tt></td><td><tt>city</tt></td><td>Miejscowo¶æ</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_GENDER</tt></td><td><tt>gender</tt></td><td>P³eæ. Je¶li szukamy kobiet, ma warto¶æ ,,<tt>1</tt>'' (sta³a <tt>GG_PUBDIR50_GENDER_FEMALE</tt>). Je¶li mê¿czyzn, ma warto¶æ ,,<tt>2</tt>'' (sta³a <tt>GG_PUBDIR50_GENDER_MALE</tt>). W przypadku pobierania lub ustawiania informacji o sobie sta³e maj± odwrócone znaczenia (sta³e <tt>GG_PUBDIR50_GENDER_SET_FEMALE</tt> i <tt>GG_PUBDIR50_GENDER_SET_MALE</tt>)</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_ACTIVE</tt></td><td><tt>ActiveOnly</tt></td><td>Je¶li szukamy tylko dostêpnych osób, ma mieæ warto¶æ ,,<tt>1</tt>'' (sta³a <tt>GG_PUBDIR50_ACTIVE_TRUE</tt>).</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FAMILYNAME</tt></td><td><tt>familyname</tt></td><td>Nazwisko panieñskie. Ma znaczenie tylko przy ustawianiu w³asnych danych.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_FAMILYCITY</tt></td><td><tt>familycity</tt></td><td>Miejscowo¶æ pochodzenia. Ma znaczenie tylko przy ustawianiu w³asnych danych.</td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_START</tt></td><td><tt>fmstart</tt></td><td>Numer, od którego rozpocz±æ wyszukiwanie. Ma znaczenie, gdy kontynuujemy wyszukiwanie.</td></tr>
</table>

<p>
Tre¶æ przyk³adowego zapytania (pomijaj±c pola <tt>type</tt> i <tt>seq</tt>) znajduje siê poni¿ej. Szukano dostêpnych kobiet o imieniu Ewa z Warszawy. Znaki o kodzie 0 zast±piono kropkami.
</p>

<div class="example">
<pre>firstname.Ewa.city.Warszawa.gender.1.ActiveOnly.1.</pre>
</div>

<p>
Wynik zapytania zostanie zwrócony za pomoc± pakietu:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_REPLY 0x000e
	
struct gg_pubdir50_reply {
	char type;
	int seq;
	char reply[];
};</pre>
</div>

<p>
Pole <tt>type</tt> poza warto¶ciami takimi jak przy pakiecie typu
<tt>GG_PUBDIR50_REQUEST</tt> mo¿e przyj±æ jeszcze warto¶æ oznaczaj±c±
odpowied¼ wyszukiwania:
</p>

<div class="c">
<pre>#define GG_PUBDIR50_SEARCH_REPLY 0x05</pre>
</div>

<p>
Wyniki s± zbudowane identycznie jak w przypadku zapytañ, z t± ró¿nic±, ¿e
kolejne osoby oddzielane pustym polem: <tt>"<b>parametr</b>\0<b>warto¶æ</b>\0\0<b>parametr</b>\0<b>warto¶æ</b>\0"</tt>.
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Etykieta</b></td><td><b>Warto¶æ</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>GG_PUBDIR50_STATUS</tt></td><td><tt>FmStatus</tt></td><td>Stan szukanej osoby</td></tr>
<tr class="tabf"><td>&nbsp;</td><td><tt>nextstart</tt></td><td>Pole wystêpuj±ce w ostatnim wyniku, okre¶laj±ce, od jakiego numeru nale¿y rozpocz±æ wyszukiwanie, by otrzymaæ kolejn± porcjê danych. Podaje siê go w zapytaniu jako parametr ,,<tt>start</tt>''.</td></tr>
</table>

<p>
Przyk³adowy wynik zawieraj±cy dwie znalezione osoby:
</p>

<div class="example">
<pre>FmNumber.12345.FmStatus.1.firstname.Adam.nickname.Janek.birthyear.1979.city.Wzdów
..FmNumber.3141592.FmStatus.5.firstname.Ewa.nickname.Ewcia.birthyear.1982.city.Gd
dañsk..nextstart.0.</pre>
</div>

<p>
Wyszukiwanie <b>nie zwraca</b> nazwisk i p³ci znalezionych osób.
</p>

<hr />

<a name="ch1.11"></a>
<h3>1.11. Lista kontaktów</h3>

<p>
Od wersji 6.0 lista kontaktów na serwerze sta³a czê¶ci± sesji, zamiast
osobnej sesji HTTP. Aby wys³aæ lub pobraæ listê kontaktów z serwera nale¿y
u¿yæ pakietu:
</p>

<div class="c">
<pre>#define GG_USERLIST_REQUEST 0x0016
	
struct gg_userlist_request {
	char type;		<i>/* rodzaj zapytania */</i>
	char request[];		<i>/* tre¶æ, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Pole <tt>type</tt> oznacza rodzaj zapytania:
</p>

<div class="c">
<pre>#define GG_USERLIST_PUT 0x00            <i>/* pocz±tek eksportu listy */</i>
#define GG_USERLIST_PUT_MORE 0x01       <i>/* dalsza czê¶æ eksportu listy */</i>
#define GG_USERLIST_GET 0x02            <i>/* import listy */</i></pre>
</div>

<p>
W przypadku eksportu listy kontaktów, pole <tt>request</tt> zawiera tekst
z³o¿ony z dowolnej liczby linii postaci:
</p>

<div class="example">
<pre>imiê;nazwisko;pseudonim;wy¶wietlane;telefon_komórkowy;grupa;uin;adres_email;dostê
pny;¶cie¿ka_dostêpny;wiadomo¶æ;¶cie¿ka_wiadomo¶æ;ukrywanie;telefon_domowy</pre>
</div>

<p>
Funkcje mniej oczywistych pól to:
</p>

<ul>

<li><tt>dostêpny</tt> okre¶la d¼wiêki zwi±zane z pojawieniem siê danej osoby
i przyjmuje warto¶ci <tt>0</tt> (u¿yte zostan± ustawienia globalne), <tt>1</tt>
(d¼wiêk powiadomienia zostanie wy³±czony), <tt>2</tt> (zostanie odtworzony
plik okre¶lony w polu <tt>¶cie¿ka_dostêpny</tt>).<br />&nbsp;</li>

<li><tt>wiadomo¶æ</tt> dzia³a podobnie jak <tt>dostêpny</tt>, ale okre¶la
d¼wiêk dla przychodz±cej wiadomo¶ci.<br />&nbsp;</li>

<li><tt>ukrywanie</tt> okre¶la czy bêdziemy dostêpni (<tt>0</tt>) czy
niedostêpni (<tt>1</tt>) dla danej osoby w trybie tylko dla znajomych.</li>

</ul>

<p>
Pole niewype³nione mo¿e zostaæ puste, a w przypadku pól liczbowych, przyj±æ
warto¶æ <tt>0</tt>.
</p>

<p>
Podczas przesy³ania lista kontaktów jest dzielona na pakiety po 2048 bajtów.
Pierwszy jest wysy³any pakietem typu <tt>GG_USERLIST_PUT</tt>, ¿eby uaktualniæ
plik na serwerze, pozosta³e typu <tt>GG_USERLIST_PUT_MORE</tt>, ¿eby dopisaæ
do pliku.
</p>

<p>
Na zapytania dotycz±ce listy kontaktów serwer odpowiada pakietem:
</p>

<div class="c">
<pre>#define GG_USERLIST_REPLY 0x0010
	
struct gg_userlist_reply {
	char type;		<i>/* rodzaj zapytania */</i>
	char request[];		<i>/* tre¶æ, nie musi wyst±piæ */</i>
};</pre>
</div>

<p>
Pole <tt>type</tt> oznacza rodzaj odpowiedzi:
</p>

<div class="c">
<pre>#define GG_USERLIST_PUT_REPLY 0x00         <i>/* pocz±tek eksportu listy */</i>
#define GG_USERLIST_PUT_MORE_REPLY 0x02    <i>/* kontynuacja */</i>
#define GG_USERLIST_GET_MORE_REPLY 0x04    <i>/* pocz±tek importu listy */</i></pre>
#define GG_USERLIST_GET_REPLY 0x06         <i>/* ostatnia czê¶æ importu */</i>
</div>

<p>
W przypadku importu w polu <tt>request</tt> znajdzie siê lista kontaktów
w takiej samej postaci, w jakiej j± umieszczono. Serwer nie ingeruje w jej
tre¶æ. Podobnie jak przy wysy³aniu, przychodzi podzielona na mniejsze pakiety.
Pobieranie krótkiej listy kontaktów zwykle powoduje wys³anie pojedynczego
pakietu <tt>GG_USERLIST_GET_REPLY</tt>, a gdy lista jest d³uga, serwer mo¿e
przys³aæ dowoln± ilo¶æ pakietów <tt>GG_USERLIST_GET_MORE_REPLY</tt> przed
pakietem <tt>GG_USERLIST_GET_REPLY</tt>.
</p>

<p>
Aby usun±æ listê kontaktów z serwera nale¿y wys³aæ pust± listê kontaktów.
</p>

<hr />

<a name="ch1.12"></a>
<h3>1.12. Indeks pakietów</h3>

<p>
Pakiety wysy³ane:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Etykieta</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>0x0002</tt></td><td><tt>GG_NEW_STATUS</tt></td><td>Zmiana stanu</td></tr>
<tr class="tabf2"><td><tt>0x0007</tt></td><td><tt>GG_PONG</tt></td><td>Pong</td></tr>
<tr class="tabf"><td><tt>0x0008</tt></td><td><tt>GG_PING</tt></td><td>Ping</td></tr>
<tr class="tabf"><td><tt>0x000b</tt></td><td><tt>GG_SEND_MSG</tt></td><td>Wys³anie wiadomo¶ci</td></tr>
<tr class="tabf2"><td><tt>0x000c</tt></td><td><tt>GG_LOGIN</tt></td><td>Logowanie przed GG 6.0</td></tr>
<tr class="tabf"><td><tt>0x000d</tt></td><td><tt>GG_ADD_NOTIFY</tt></td><td>Dodanie do listy kontaktów</td></tr>
<tr class="tabf"><td><tt>0x000e</tt></td><td><tt>GG_REMOVE_NOTIFY</tt></td><td>Usuniêcie z listy kontaktów</td></tr>
<tr class="tabf"><td><tt>0x000f</tt></td><td><tt>GG_NOTIFY_FIRST</tt></td><td>Pocz±tkowy fragment listy kontaktów wiêkszej ni¿ 400 wpisów</td></tr>
<tr class="tabf"><td><tt>0x0010</tt></td><td><tt>GG_NOTIFY_LAST</tt></td><td>Ostatni fragment listy kontaktów</td></tr>
<tr class="tabf2"><td><tt>0x0013</tt></td><td><tt>GG_LOGIN_EXT</tt></td><td>Logowanie przed GG 6.0</td></tr>
<tr class="tabf"><td><tt>0x0014</tt></td><td><tt>GG_PUBDIR50_REQUEST</tt></td><td>Zapytanie katalogu publicznego</td></tr>
<tr class="tabf"><td><tt>0x0015</tt></td><td><tt>GG_LOGIN60</tt></td><td>Logowanie</td></tr>
<tr class="tabf"><td><tt>0x0016</tt></td><td><tt>GG_USERLIST_REQUEST</tt></td><td>Zapytanie listy kontaktów na serwerze</td></tr>
</table>

<p>
Pakiety odbierane:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td><b>Warto¶æ</b></td><td><b>Etykieta</b></td><td><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>0x0001</tt></td><td><tt>GG_WELCOME</tt></td><td>Liczba do wyznaczenie hashu has³a</td></tr>
<tr class="tabf"><td><tt>0x0002</tt></td><td><tt>GG_STATUS</tt></td><td>Zmiana stanu przed GG 6.0</td></tr>
<tr class="tabf"><td><tt>0x0003</tt></td><td><tt>GG_LOGIN_OK</tt></td><td>Logowanie powiod³o siê</td></tr>
<tr class="tabf"><td><tt>0x0005</tt></td><td><tt>GG_SEND_MSG_ACK</tt></td><td>Potwierdzenie wiadomo¶ci</td></tr>
<tr class="tabf2"><td><tt>0x0007</tt></td><td><tt>GG_PONG</tt></td><td>Pong</td></tr>
<tr class="tabf2"><td><tt>0x0008</tt></td><td><tt>GG_PING</tt></td><td>Ping</td></tr>
<tr class="tabf"><td><tt>0x0009</tt></td><td><tt>GG_LOGIN_FAILED</tt></td><td>Logowanie nie powiod³o siê</td></tr>
<tr class="tabf"><td><tt>0x000a</tt></td><td><tt>GG_RECV_MSG</tt></td><td>Przychodz±ca wiadomo¶æ</td></tr>
<tr class="tabf"><td><tt>0x000b</tt></td><td><tt>GG_DISCONNECTING</tt></td><td>Zerwanie po³±czenia</td></tr>
<tr class="tabf"><td><tt>0x000c</tt></td><td><tt>GG_NOTIFY_REPLY</tt></td><td>Stan listy kontaktów przed GG 6.0</td></tr>
<tr class="tabf"><td><tt>0x000e</tt></td><td><tt>GG_PUBDIR50_REPLY</tt></td><td>Odpowied¼ katalogu publicznego</td></tr>
<tr class="tabf"><td><tt>0x000f</tt></td><td><tt>GG_STATUS60</tt></td><td>Zmiana stanu</td></tr>
<tr class="tabf"><td><tt>0x0010</tt></td><td><tt>GG_USERLIST_REPLY</tt></td><td>Odpowied¼ listy kontaktów na serwerze</td></tr>
<tr class="tabf"><td><tt>0x0011</tt></td><td><tt>GG_NOTIFY_REPLY60</tt></td><td>Stan listy kontaktów</td></tr>
</table>

<hr />

<a name="ch2"></a>
<h2>2. Us³ugi HTTP</h2>

<a name="ch2.1"></a>
<h3>2.1. Format danych</h3>

<p>
Komunikacja z <tt>appmsg.gadu-gadu.pl</tt> metod± <tt>GET</tt> HTTP/1.0
zosta³a opisana w poprzednim rozdziale, pozosta³e pakiety u¿ywaj± 
<tt>POST</tt> dla HTTP/1.0, a w odpowiedzi 1.1. Maj± one postaæ:
</p>

<div class="http">
<pre>POST <b>¦CIE¯KA</b> HTTP/1.0
Host: <b>HOST</b>
Content-Type: application/x-www-form-urlencoded
User-Agent: <b>AGENT</b>
Content-Length: <b>D£UGO¦Æ</b>
Pragma: no-cache

<b>DANE</b></pre>
</div>

<p>
Gdzie <tt><b>AGENT</b></tt> to nazwa przegl±darki (na przyk³ad <tt>Mozilla/4.0
(compatible; MSIE 5.0; Windows 98)</tt> lub inne, wymienione w rozdziale
<a href="#ch1.2">1.2</a>), <tt><b>D£UGO¦Æ</b></tt> to d³ugo¶æ bloku
<tt><b>DANE</b></tt> w znakach.
</p>

<p>
Je¶li bêdzie mowa o wysy³aniu danych do serwera, to chodzi o ca³y powy¿szy
pakiet, opisane zostan± tylko: <tt><b>HOST</b></tt>, <tt><b>¦CIE¯KA</b></tt>
i <tt><b>DANE</b></tt>. Pakiet jest wysy³any na port 80. Gdy mowa o wysy³aniu
pól zapytania, mowa o <tt><b>DANE</b></tt> o warto¶ci:
</p>

<div class="http">
<pre>pole1=warto¶æ1&amp;pole2=warto¶æ2&amp;...</pre>
</div>

<p>
Pamiêtaj o zmianie kodowania na CP1250 i zakodowaniu danych do postaci URL
(na przyk³ad funkcj± typu <tt>urlencode</tt>).
</p>

<p>
Odpowiedzi serwera na powy¿sze zapytania maj± mniej wiêcej postaæ:
</p>

<div class="http">
<pre>HTTP/1.1 200 OK
Server: Microsoft-IIS/5.0
Date: Mon, 01 Jul 2002 22:30:31 GMT
Connection: Keep-Alive
Content-Length: <b>D£UGO¦Æ</b>
Content-Type: text/html
Set-Cookie: <b>COOKIE</b>
Cache-control: private

<b>ODPOWIED¬</b></pre>
</div>

<p>
Nag³ówki nie s± dla nas wa¿ne. Mo¿na zauwa¿yæ tylko to, ¿e czasami serwer
ustawia <tt><b>COOKIE</b></tt> np. ,,<tt>ASPSESSIONIDQQGGGLJC=CAEKMBGDJCFBEOKCELEFCNKH; path=/</tt>''. Pisz±c dalej, ¿e serwer ,,odpowie warto¶ci±'' mowa
tylko o polu <b>ODPOWIED¬</b>. Kodowanie znaków w odpowiedzi to CP1250.
</p>

<hr />

<a name="ch2.2"></a>

<h3>2.2. Tokeny</h3> 

<p>
Prawdopodobnie ze wzglêdu na nadu¿ycia i wykorzystywanie automatów
rejestruj±cych do polowañ na ,,z³ote numery GG'', wprowadzono konieczno¶æ
autoryzacji za pomoc± tokenu. Ka¿da operacja zaczyna siê od pobrania tokenu
z serwera, wy¶wietlenia u¿ytkownikowi, odczytaniu jego warto¶ci i wys³ania
zapytania z identyfikatorem i warto¶ci± tokenu. Pobranie tokenu wygl±da 
nastêpuj±co:
</p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/regtoken.asp</tt></td></tr>
</table>

<p>
Nie s± wysy³ane ¿adne parametry. Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/regtoken.asp HTTP/1.0
Host: register.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 0
Pragma: no-cache
</pre>
</div>

<p>
Serwer w odpowiedzi ode¶le:
</p>

<div class="http">
<pre><b>SZEROKO¦Æ WYSOKO¦Æ D£UGO¦Æ
IDENTYFIKATOR
¦CIE¯KA</b></pre></div>

<p>
Gdzie <tt><b>SZEROKO¦Æ</b></tt> i <tt><b>WYSOKO¦Æ</b></tt> opisuj± wymiary
obrazka z warto¶ci± tokenu, <tt><b>D£UGO¦Æ</b></tt> mówi ile znaków zawiera
token, <tt><b>IDENTYFIKATOR</b></tt> jest identyfikatorem tokenu (tylko do
niego pasuje warto¶æ tokenu), a <tt><b>¦CIE¯KA</b></tt> to ¶cie¿ka do skryptu
zwracaj±cego obrazek z warto¶ci± tokenu. Przyk³adowa odpowied¼:
</p>

<div class="http">
<pre>60 24 6
06C05A44
http://register.gadu-gadu.pl/appsvc/tokenpic.asp</pre></div>

<p>
Mo¿emy teraz pobraæ metod± GET z podanej ¶cie¿ki obrazek z tokenem, doklejaj±c
do ¶cie¿ki parametr <tt><b>tokenid</b></tt> o warto¶ci bed±cej identyfikatorem
uzyskanym przed chwil±. Adres obrazka z warto¶ci± tokenu dla powy¿szego
przyk³adu to:
</p>

<div class="example">
<pre>http://register.gadu-gadu.pl/appsvc/tokenpic.asp?tokenid=06C05A44</pre>
</div>

<p>
Pobrany obrazek (w tej chwili jest w formacie JPEG, ale prawdopodobnie mo¿e
siê to zmieniæ na dowolny format obs³ugiwany domy¶lnie przez system Windows)
najlepiej wy¶wietliæ u¿ytkownikowi, prosz±c o podanie warto¶ci na nim
przedstawionej. Bêdzie ona niezbêdna do przeprowadzenia kolejnych operacji.
</p>

<hr />

<a name="ch2.3"></a>

<h3>2.3. Rejestracja konta</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister3.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>has³o dla nowego numeru</td></tr>
<tr class="tabf"><td><tt>email</tt></td><td>e-mail na który bêdzie przesy³ane przypomnienie has³a</td></tr>
<tr class="tabf"><td><tt>tokenid</tt></td><td>identyfikator tokenu</td></tr>
<tr class="tabf"><td><tt>tokenval</tt></td><td>warto¶æ tokenu</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pól <tt>email</tt> i <tt>pwd</tt>. Algorytmu szukaj w ¼ród³ach libgadu w <tt>lib/common.c</tt></td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmregister3.asp HTTP/1.0
Host: register.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 76
Pragma: no-cache
		
pwd=sekret&amp;email=abc&#64;xyz.pl<!-- &amp;qa=5~Maria -->&amp;tokenid=06C05A44&amp;tokenval=e94d56&amp;code=1104465363</pre>
</div>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<p>
Gdzie <tt><b>UIN</b></tt> to nowy numer, który w³a¶nie otrzymali¶my.
</p>

<hr />

<a name="ch2.4"></a>
<h3>2.4. Usuniêcie konta</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister3.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>fmnumber</tt></td><td>usuwany numer</td></tr>
<tr class="tabf"><td><tt>fmpwd</tt></td><td>has³o</td></tr>
<tr class="tabf"><td><tt>delete</tt></td><td>warto¶æ ,,<tt>1</tt>''</td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>losowa liczba</td></tr>
<tr class="tabf"><td><tt>email</tt></td><td>warto¶æ ,,<tt>deletedaccount@gadu-gadu.pl</tt>''</td></tr>
<tr class="tabf"><td><tt>tokenid</tt></td><td>identyfikator tokenu</td></tr>
<tr class="tabf"><td><tt>tokenval</tt></td><td>warto¶æ tokenu</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pól <tt>pwd</tt> i <tt>email</tt></td></tr>
</table>

<p>
Przyk³ad:
</p>

<div class="http">
<pre>POST /appsvc/fmregister2.asp HTTP/1.0
Host: register.gadu-gadu.pl
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/4.0 (compatible; MSIE 5.0; Windows 98)
Content-Length: 137
Pragma: no-cache
		
fmnumber=4969256&amp;fmpwd=haslo&amp;delete=1&amp;email=deletedaccount@gadu-gadu.pl&amp;pwd=%2D38
8046464&amp;tokenid=06C05A44&amp;tokenval=e94d56&amp;code=1483497094</pre>
</div>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<p>
Gdzie <tt><b>UIN</b></tt> to numer, który skasowali¶my.
</p>

<hr />

<a name="ch2.5"></a>
<h3>2.5. Zmiana has³a</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>register.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmregister3.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>fmnumber</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>fmpwd</tt></td><td>stare has³o</td></tr>
<tr class="tabf"><td><tt>pwd</tt></td><td>nowe has³o</td></tr>
<tr class="tabf"><td><tt>email</tt></td><td>nowe adres e-email</td></tr>
<tr class="tabf"><td><tt>tokenid</tt></td><td>identyfikator tokenu</td></tr>
<tr class="tabf"><td><tt>tokenval</tt></td><td>warto¶æ tokenu</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pól <tt>pwd</tt> i <tt>email</tt></td></tr>
</table>

<p>
Je¶li wszystko przebieg³o poprawnie, serwer odpowie:
</p>

<div class="http">
<pre>reg_success:<b>UIN</b></pre>
</div>

<hr />

<a name="ch2.6"></a>
<h3>2.6. Przypomnienie has³a poczt±</h3>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Pole nag³ówka</b></td><td width="80%"><b>Warto¶æ</b></td></tr>
<tr class="tabf"><td><tt>HOST</tt></td><td><tt>retr.gadu-gadu.pl</tt></td></tr>
<tr class="tabf"><td><tt>¦CIE¯KA</tt></td><td><tt>/appsvc/fmsendpwd3.asp</tt></td></tr>
</table>

<p></p>

<table class="tab" border="0" cellspacing="1" cellpadding="2" width="100%">
<tr class="tabh"><td width="20%"><b>Wysy³amy pole</b></td><td width="80%"><b>Znaczenie</b></td></tr>
<tr class="tabf"><td><tt>userid</tt></td><td>numer</td></tr>
<tr class="tabf"><td><tt>tokenid</tt></td><td>identyfikator tokenu</td></tr>
<tr class="tabf"><td><tt>tokenval</tt></td><td>warto¶æ tokenu</td></tr>
<tr class="tabf"><td><tt>code</tt></td><td>hash liczony z pola <tt>userid</tt></td></tr>
</table>

<p>
Je¶li siê uda³o, serwer odpowie:
</p>

<div class="http">
<pre>pwdsend_success</pre>
</div>

<hr />

<a name="ch3"></a>
<h2>3. Po³±czenia bezpo¶rednie</h2>

<a name="ch3.1"></a>
<h3>3.1. Nawi±zanie po³±czenia</h3>

<p>
Po³±czenia bezpo¶rednie pozwalaj± przesy³aæ pliki lub prowadziæ rozmowy
g³osowe bez po¶rednictwa serwera. Pocz±tkowe wersje Gadu-Gadu potrafi³y
przesy³aæ bezpo¶rednio równie¿ wiadomo¶ci tekstowe, ale funkcjonalno¶æ
ta zosta³a zarzucona.
</p>

<p>
Po³±czenia s± mo¿liwe jedynie w sytuacji, gdy co najmniej jedna ze stron
posiada publiczny adres IP. Je¶li jest to strona wywo³ywana, wystarczy
po³±czyæ siê na podany adres IP i port. Gdy nie ma mo¿liwo¶ci po³±czenia
siê ze stron± wywo³ywan±, nale¿y wys³aæ do niej wiadomo¶æ klasy
<tt>GG_CLASS_CTCP</tt>, zawieraj±c± jeden bajt o warto¶ci <tt>0x02</tt>.
Odebranie takiej wiadomo¶ci powinno spowodowaæ po³±czenie bezpo¶rednie
z nadawc±, w którym role stron bêd± zamienione a¿ do momentu okre¶lenia
rzeczywistego kierunku transmisji.
</p>

<p>
Po nawi±zaniu po³±czenia nale¿y wys³aæ pakiet zawieraj±cy numery Gadu-Gadu
strony wywo³uj±cej i wywo³ywanej. W odró¿nieniu od po³±czenia z serwerem,
w po³±czeniach bezpo¶rednich pakiety nie s± poprzedzane strukturami
<tt>gg_header</tt>.
</p>

<div class="c">
<pre>struct gg_dcc_welcome {
	int uin;	<i>/* numer strony wywo³uj±cej */</i>
	int peer_uin;	<i>/* numer strony wywo³ywanej */</i>
};</pre>
</div>

<p>
Strona wywo³ywana sprawdza, czy nadawca istnieje w li¶cie kontaktów i czy
³±czy siê z tego samego adresu, który zg³osi³ serwerowi. Gdy który¶ z
parametrów siê nie zgadza, po³±czenie nale¿y ze wzglêdów bezpieczeñstwa
zerwaæ. Pomy¶lna autoryzacja jest sygnalizowana przez wys³anie do strony
wywo³uj±cej pakietu:
</p>

<div class="c">
<pre>struct gg_dcc_welcome_ack {
	int ack;	<i>/* warto¶æ 0x47414455, tekst "UDAG" */</i>
};</pre>
</div>

<p>
Strona wywo³uj±ca nastêpnie wysy³a pakiet, w którym okre¶la kto w³a¶ciwie
ma rozpocz±æ transmisjê:
</p>

<div class="c">
<pre>#define GG_DCC_DIRECTION_IN 0x0002
#defnie GG_DCC_DIRECTION_OUT 0x0003

struct gg_dcc_direction {
	int type;	<i>/* w któr± stronê po³±czenie? */</i>
};</pre>
</div>

<p>
Je¶li strona wywo³uj±ca by³a stron± inicjuj±c± po³±czenie bezpo¶rednie (nie
chodzi o po³±czenie TCP, a o ¿±danie u¿ytkownika), wysy³a
<tt>GG_DCC_DIRECTION_IN</tt>, a nastêpnie wysy³a pakiety zale¿ne od rodzaju
po³±czenia bezpo¶redniego, opisane w dalszych rozdzia³ach. Gdy strona
wywo³uj±ca zosta³a poproszona o po³±czenie za pomoc± wiadomo¶ci klasy
<tt>GG_CLASS_CTCP</tt>, wysy³a <tt>GG_DCC_DIRECTION_OUT</tt> i oczekuje na
pakiet zale¿ny od rodzaju po³±czenia bezpo¶redniego. Jak widaæ, rzeczywisty
kierunek transmisji jest ju¿ okre¶lony.
</p>

<hr />

<a name="ch3.2"></a>
<h3>3.2. Przesy³anie plików</h3>

<p>
Aby powiadomo¶æ o chêci przes³ania pliku, nale¿y wys³aæ nastêpuj±ce pakiety.
Pierwszy okre¶la rodzaj po³±czenia, drugi zawiera szczegó³y dotycz±ce pliku.
</p>

<div class="c">
<pre>#define GG_DCC_REQUEST_SEND 0x0001

struct gg_dcc_request {
	int type;	<i>/* GG_DCC_REQUEST_SEND */</i>
};

#define GG_DCC_FILE_INFO 0x0003

struct gg_dcc_file_info {
	int type;			<i>/* GG_DCC_FILE_INFO */</i>
	int unknown1;			<i>/* == 0 */</i>
	int unknown2;			<i>/* == 0 */</i>

	struct gg_file_info {
		int dwFileAttributes;		<i>/* atrybuty pliku */</i>
		long long ftCreationTime;	<i>/* czas utworzenia pliku */</i>
		long long ftLastAccessTime;	<i>/* czas ostatniego dostêpu */</i>
		long long ftLastWriteTime;	<i>/* czas ostatniego zapisu */</i>
		int nFileSizeHigh;		<i>/* górne 32 bity rozmiaru */</i>
		int nFileSizeLow;		<i>/* dolne 32 bity rozmiaru */</i>
		int dwReserved0;		<i>/* == 0 */</i>
		int dwReserved1;		<i>/* == 0 */</i>
		char cFileName[262];		<i>/* nazwa pliku */</i>
		char cAlternateFileName[14];	<i>/* krótka nazwa pliku */</i>
	} info;
};</pre>
</div>

<p>
Struktura <tt>gg_file_info</tt> odpowiada strukturze <tt>WIN32_FIND_DATA</tt>
z API Win32.
</p>

<p>
Strona wywo³ywana, w przypadku gdy u¿ytkownik zaakceptuje pobranie pliku,
odsy³a pakiet:
</p>

<div class="c">
<pre>#define GG_DCC_SEND_ACK 0x0006

struct gg_dcc_send_ack {
	int type;	<i>/* GG_DCC_SEND_ACK */</i>
	int offset;	<i>/* od którego zaczynamy przesy³anie */</i>
	int unknown1;	<i>/* == 0 */</i>
};</pre>
</div>

<p>
Je¶li plik zosta³ ju¿ czê¶ciowo odebrany i chcemy wznowiæ przesy³anie,
w polu <tt>offset</tt> wystarczy podaæ ile bajtów ju¿ mamy, a odebrane
dane dopisaæ na koñcu pliku.
</p>

<p>
Po zaakceptowaniu pliku, strona wywo³uj±ca przesy³a jego zawarto¶æ podzielon±
na pakiety, a nastêpnie zamyka po³±czenie.
</p>

<div class="c">
<pre>#define GG_DCC_SEND_DATA 0x0003
#define GG_DCC_SEND_DATA_LAST 0x0002

struct gg_dcc_send_data {
	int type;	<i>/* typ pakietu */</i>
	int length;	<i>/* rozmiar pakietu */</i>
	char data[];	<i>/* dane */</i>
};</pre>
</div>

<p>
Domy¶lnie dane s± dzielone na pakiety o rozmiarze 4096 bajtów. Ostatni pakiet
danych jest oznaczany typem <tt>GG_DCC_SEND_DATA_LAST</tt>, podczas gdy
pozosta³e <tt>GG_DCC_SEND_DATA</tt>. Podczas implementacji dobrze by³o by
rozwa¿yæ, czy strona wywo³ywana powinna odebraæ nie wiêcej ni¿ rozmiar pliku
zadeklarowany w strukturze <tt>gg_file_info</tt> czy odbieraæ dane a¿ do
otrzymania pakietu typu <tt>GG_DCC_SEND_DATA_LAST</tt>, implementacji.
</p>

<hr />

<a name="ch3.3"></a>
<h3>3.3. Rozmowy g³osowe</h3>

<p>
Aby powiadomo¶æ o chêci rozmowy g³osowej nale¿y wys³aæ pakiet:
</p>

<div class="c">
<pre>#define GG_DCC_REQUEST_VOICE 0x0002

struct gg_dcc_request {
	int type;	<i>/* GG_DCC_REQUEST_VOICE */</i>
};</pre>
</div>

<p>
Strona wywo³ana mo¿e potwierdziæ chêæ przeprowadzenia rozmowy za pomoc±
pakietu:
</p>

<div class="c">
<pre>#define GG_DCC_VOICE_ACK 0x01

struct gg_dcc_voice_ack {
	char type;	<i>/* GG_DCC_VOICE_ACK */</i>
};</pre>
</div>

<p>
Je¶li strona wywo³ana chce odrzuciæ rozmowê g³osow±, zrywa po³±czenie.
Mimo tego, strona wywo³uj±ca nie powinna ignorowaæ warto¶ci potwierdzenia.
</p>

<p>
Nastêpnie przesy³ane s± próbki d¼wiêkowe kodowane microsoftowym wariantem
GSM. Pod systemem Windows wystarczy u¿yæ standardowego kodeka, pod innymi
mo¿na skorzystaæ z biblioteki
<a href="http://kbs.cs.tu-berlin.de/~jutta/toast.html">libgsm</a> z opcj±
WAV49. Pakiet danych wygl±da nastêpuj±co:
</p>

<div class="c">
<pre>#define GG_DCC_VOICE_DATA 0x03

struct gg_dcc_voice_data {
	char type;	<i>/* GG_DCC_VOICE_DATA */</i>
	int length;	<i>/* d³ugo¶æ pakietu */</i>
	char data[];	<i>/* dane */</i>
};</pre>
</div>

<p>
W celu zakoñczenia rozmowy g³osowej, zamiast powy¿szej ramki wysy³a siê:
</p>

<div class="c">
<pre>#define GG_DCC_VOICE_TERMINATE 0x04

struct gg_dcc_voice_terminate {
	char type;	<i>/* GG_DCC_VOICE_TERMINATE */</i>
};</pre>
</div>

<p>
Do wersji 5.0.5 w jednym pakiecie by³o umieszczone 6 ramek GSM (<i>6 * 32,5 =
195 bajtów</i>), a pocz±wszy od tej wersji przesy³a siê po 10 ramek GSM,
poprzedzaj±c je bajtem zerowym (<i>1 + 10 * 32,5 = 326 bajtów</i>).
</p>

<hr />

<pre>
----- 3) transmisja pliku: strona nadawcy -------------------------------------
Nadawca wysy³a  po kolei:

	#define GG_DCC_HAVE_FILE     0x0001
	#define GG_DCC_HAVE_FILEINFO 0x0003
	int unknown1; /* 0 */
	int unknown2; /* 0 */
	file_info_struct finfo;

Podejrzewam, ¿e unknown2:unknown1 jest pozycj± w pliku, od której nadawca 
chce wysy³aæ plik, ale nie uda³o mi siê zasymulowaæ sytuacji, w której 
by³yby u¿ywane.

	struct file_info_struct {
        	int mode;                  /* dwFileAttributes */
        	int ctime[2];              /* ftCreationTime */
        	int atime[2];              /* ftLastAccessTime */
        	int mtime[2];              /* ftLastWriteTime */
		int size_hdw;              /* górne 4 bajty d³ugo¶ci pliku */
		int size_ldw;              /* dolne 4 bajty d³ugo¶ci pliku */
		int reserved1;             /* 0 */
		int reserved2;             /* 0 */
		char file_name[276];       /* tablica zaczynaj±ca siê od nazwy 
					      pliku, wype³niona zerami */
	};

Dalej nadawca czeka na akceptacjê odbiorcy, czyli nastêpuj±c± strukturkê:
	
	struct {
		int type;      /* 0x0006 GG_DCC_GIMME_FILE */
		int start;     /* od której pozycji zacz±æ przesy³anie */
		int unknown;   /* 0 */
	};

Teraz mo¿emy zacz±æ przesy³anie pliku. Plik przesy³amy w paczkach d³ugo¶ci 
ustalonej przez nadawcê. Przed ka¿d± paczk± z danymi nadawca wysy³a nag³ówek
paczki:
	struct {
		int type;       /* 0x0003 GG_DCC_FILEHEADER, je¶li paczka nie 
				   jest ostatnia. 0x0002 GG_DCC_LAST_FILEHEADER
				   wpp. */
		int chunk_size; /* rozmiar paczki */
		int unknown;    /* 0 */
	};

Po wys³aniu ostatniej paczki zamykamy po³±czenie. Plik zosta³ przes³any.

----- 4) transmisja pliku: strona odbiorcy ------------------------------------
Zachowanie odbiorcy jest symetryczne:
1. odbiera kolejno 
	GG_DCC_HAVE_FILE
	GG_DCC_HAVE_FILEINFO
	int unknown1;
	int unknown2;
	file_info_struct finfo;

2. je¶li u¿ytkownik zgodzi siê odebraæ plik, to wysy³amy struktrê jakiej
odbiorca siê spodziewa.

3. otrzymujemy nag³ówek paczki i paczkê z danymi zadeklarowanej d³ugo¶ci
4. je¶li nag³ówek by³ typu GG_DCC_LAST_FILEHEADER to otrzymali¶my ca³o¶æ, 
wiêc zamykamy po³±czenie. Je¶li nie, to wracamy do kroku 3.
</pre>

<hr />

<a name="ch4"></a>
<h2>4. Autorzy</h2>

<p>
Autorami powy¿szego opisu s±:
</p>

<ul>
	<li><b>Wojtek Kaniewski</b> (wojtekka%irc.pl): pierwsza wersja opisu,
	poprawki, utrzymanie wszystkiego w porz±dku.</li>
	<li><b>Robert J. Wo¼ny</b> (speedy%atman.pl): opis nowo¶ci w protokole
	GG 4.6, poprawki.</li>
	<li><b>Tomasz Jarzynka</b> (tomee%cpi.pl): badanie timeoutów.</li>
	<li><b>Adam Ludwikowski</b> (adam.ludwikowski%wp.pl): wiele poprawek,
	wersje klientów, rozszerzone wiadomo¶ci, powody nieobecno¶ci.</li>
	<li><b>Marek Kozina</b> (klith%hybrid.art.pl): czas otrzymania
	wiadomo¶ci.</li>
	<li><b>Rafa³ Florek</b> (raf%regionet.regionet.pl): opis po³±czeñ
	konferencyjnych.</li>
	<li><b>Igor Popik</b> (igipop%wsfiz.edu.pl): klasy wiadomo¶ci przy
	odbieraniu zakolejkowanej.</li>
	<li><b>Rafa³ Cyran</b> (ajron%wp.pl): informacje o remote_port,
	rodzaje potwierdzeñ przy ctcp, GG_LOGIN_EXT.</li>
	<li><b>Piotr Mach</b> (pm%gadu-gadu.com): ilo¶æ kontaktów, pe³na
	skrzynka, pusta lista, maska audio, us³ugi HTTP, GG_LOGIN_EXT.</li>
	<li><b>Adam Czy¶ciak</b> (acc%interia.pl): potwierdzenie wiadomo¶ci
	GG_CLASS_ACK.</li>
	<li><b>Kamil Dêbski</b> (kdebski%kki.net.pl): czas w stanach
	opisowych.</li>
	<li><b>Pawe³ Piwowar</b> (alfapawel%go2.pl): format czasu.</li>
	<li><b>Tomasz Chiliñski</b> (chilek%chilan.com): nowo¶ci w 5.0.2.</li>
	<li><b>Rados³aw Nowak</b> (rano%ranosoft.net): uzupe³nienie statusu
	opisowego, wersja 5.0.3.</li>
	<li><b>Walerian Soko³owski</b>: pierwsza wersja opisu protoko³u
	bezpo¶rednich po³±czeñ.</li>
	<li><b>Nikodem</b> (n-d%tlen.pl): flagi rodzaju u¿ytkownika.</li>
</ul>

<hr />

<font color="silver">
$Id$
</font>

</td></tr></table>
</center>

</body>
</html>
